<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile Save Editor</title>
</head>
<body>
  <h1>Profile Save Editor</h1>

  <input type="file" id="fileInput" accept=".save"><br><br>

  <button onclick="decryptProfile()">Decrypt Profile.save</button><br><br>

  <textarea id="output" rows="20" cols="80" readonly></textarea><br><br>

  <textarea id="editInput" rows="10" cols="80" placeholder="Edit your profile JSON here"></textarea><br><br>

  <button onclick="encryptAndSave()">Encrypt and Save</button>

  <script>
    async function decryptProfile() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];

      if (!file) {
        alert('Please select a file.');
        return;
      }

      try {
        let decryptedProfile = await readAndDecryptFile(file);
        document.getElementById('output').value = JSON.stringify(decryptedProfile, null, 2);
        document.getElementById('editInput').value = JSON.stringify(decryptedProfile, null, 2);
      } catch (err) {
        console.error('Error decrypting:', err);
      }
    }

    async function readAndDecryptFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = async function(event) {
          try {
            const fileContent = event.target.result;
            const decryptedProfile = await decryptFileContent(fileContent);
            resolve(decryptedProfile);
          } catch (error) {
            reject(error);
          }
        };

        reader.readAsArrayBuffer(file);
      });
    }

    async function decryptFileContent(fileContent) {
      const fileBytes = new Uint8Array(fileContent);
      const salt = fileBytes.slice(DUMMY_HEADER_LENGTH + PASSWORD_INDEX_LENGTH, DUMMY_HEADER_LENGTH + PASSWORD_INDEX_LENGTH + SALT_LENGTH);
      const encryptedBytes = fileBytes.slice(DUMMY_HEADER_LENGTH + PASSWORD_INDEX_LENGTH + SALT_LENGTH);

      const password = '21';
      const iv = fileBytes.slice(DUMMY_HEADER_LENGTH + PASSWORD_INDEX_LENGTH, DUMMY_HEADER_LENGTH + PASSWORD_INDEX_LENGTH + IV_LENGTH);

      const keyMaterial = await deriveKeyFromPassword(password, salt);
      const decryptedBytes = await decryptWithKey(keyMaterial, iv, encryptedBytes);

      const inflatedBytes = zlib.inflateSync(decryptedBytes);
      const decryptedText = new TextDecoder().decode(inflatedBytes);

      return JSON.parse(decryptedText);
    }

    async function deriveKeyFromPassword(password, salt) {
      const passwordBytes = new TextEncoder().encode(password);
      const importedKey = await window.crypto.subtle.importKey(
        'raw',
        passwordBytes,
        { name: 'PBKDF2' },
        false,
        ['deriveBits', 'deriveKey']
      );

      const keyMaterial = await window.crypto.subtle.deriveKey(
        {
          name: 'PBKDF2',
          salt: salt,
          iterations: DERIVE_ITERATIONS,
          hash: 'SHA-1'
        },
        importedKey,
        { name: 'AES-CBC', length: 128 },
        true,
        ['decrypt']
      );

      return keyMaterial;
    }

    async function decryptWithKey(key, iv, data) {
      const decrypted = await window.crypto.subtle.decrypt(
        {
          name: 'AES-CBC',
          iv: iv
        },
        key,
        data
      );

      return new Uint8Array(decrypted);
    }

    async function encryptAndSave() {
      let editedProfileJson = document.getElementById('editInput').value;

      if (!editedProfileJson) {
        alert('Please edit the profile JSON.');
        return;
      }

      const password = '21';

      // TODO: encryption logic in browser environment (not implemented in this commit)

      console.log('Profile encrypted and saved successfully.');
    }
  </script>
</body>
</html>
