<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile Save Editor</title>
</head>
<body>
  <h1>Profile Save Editor</h1>

  <input type="file" id="fileInput" accept=".save"><br><br>

  <button onclick="decryptProfile()">Decrypt Profile.save</button><br><br>

  <textarea id="output" rows="20" cols="80" readonly></textarea><br><br>

  <textarea id="editInput" rows="10" cols="80" placeholder="Edit your profile JSON here"></textarea><br><br>

  <button onclick="encryptAndSave()">Encrypt and Save</button>

  <script>
    async function decryptProfile() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];

      if (!file) {
        alert('Please select a file.');
        return;
      }

      try {
        let decryptedProfile = await readAndDecryptFile(file);
        document.getElementById('output').value = JSON.stringify(decryptedProfile, null, 2);
        document.getElementById('editInput').value = JSON.stringify(decryptedProfile, null, 2);
      } catch (err) {
        console.error('Error decrypting:', err);
      }
    }

    async function readAndDecryptFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = async function(event) {
          try {
            const fileContent = event.target.result;
            const decryptedProfile = await decryptFileContent(fileContent);
            resolve(decryptedProfile);
          } catch (error) {
            reject(error);
          }
        };

        reader.readAsText(file);
      });
    }

    async function decryptFileContent(fileContent) {
      // Convert the file content (base64 string) back to Uint8Array
      const fileBytes = new Uint8Array(atob(fileContent).split('').map(char => char.charCodeAt(0)));

      // Derive the key and IV
      const password = '21'; // Replace with your actual password
      const salt = fileBytes.slice(44, 68); // Extract salt from file (adjust according to your file structure)
      const iv = fileBytes.slice(68, 84); // Extract IV from file (adjust according to your file structure)

      const keyMaterial = await window.crypto.subtle.importKey(
        'raw',
        new TextEncoder().encode(password),
        { name: 'PBKDF2' },
        false,
        ['deriveKey']
      );

      const derivedKey = await window.crypto.subtle.deriveKey(
        {
          name: 'PBKDF2',
          salt,
          iterations: 1000,
          hash: 'SHA-256'
        },
        keyMaterial,
        { name: 'AES-CBC', length: 128 },
        true,
        ['decrypt']
      );

      const decryptedData = await window.crypto.subtle.decrypt(
        {
          name: 'AES-CBC',
          iv
        },
        derivedKey,
        fileBytes.slice(84) // Encrypted data starts from index 84 (adjust according to your file structure)
      );

      const decryptedText = new TextDecoder().decode(decryptedData);
      return JSON.parse(decryptedText);
    }

    async function encryptAndSave() {
      let editedProfileJson = document.getElementById('editInput').value;

      if (!editedProfileJson) {
        alert('Please edit the profile JSON.');
        return;
      }

      const password = '21'; // Replace with your actual password

      const keyMaterial = await window.crypto.subtle.importKey(
        'raw',
        new TextEncoder().encode(password),
        { name: 'PBKDF2' },
        false,
        ['deriveKey']
      );

      const salt = window.crypto.getRandomValues(new Uint8Array(24));
      const iv = window.crypto.getRandomValues(new Uint8Array(16));

      const derivedKey = await window.crypto.subtle.deriveKey(
        {
          name: 'PBKDF2',
          salt,
          iterations: 1000,
          hash: 'SHA-256'
        },
        keyMaterial,
        { name: 'AES-CBC', length: 128 },
        true,
        ['encrypt']
      );

      const encryptedData = await window.crypto.subtle.encrypt(
        {
          name: 'AES-CBC',
          iv
        },
        derivedKey,
        new TextEncoder().encode(editedProfileJson)
      );

      const encryptedArray = new Uint8Array(encryptedData);
      const encryptedBytes = new Uint8Array(44 + salt.length + iv.length + encryptedArray.length);
      
      // Construct the encrypted file
      encryptedBytes.set(new TextEncoder().encode('DummyHeader'), 0); // Example: DummyHeader
      encryptedBytes.set(salt, 44); // Offset for salt
      encryptedBytes.set(iv, 68); // Offset for IV
      encryptedBytes.set(encryptedArray, 84); // Offset for encrypted data

      const encryptedBlob = new Blob([encryptedBytes], { type: 'application/octet-stream' });
      const downloadLink = document.createElement('a');
      downloadLink.href = URL.createObjectURL(encryptedBlob);
      downloadLink.download = 'EncryptedProfile.save';
      downloadLink.click();

      console.log('Profile encrypted and saved successfully.');
    }
  </script>
</body>
</html>
